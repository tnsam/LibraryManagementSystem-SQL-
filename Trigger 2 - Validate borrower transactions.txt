DROP TRIGGER TRG_VERIFY_DUPLICATE_TRANSACTION;

CREATE OR REPLACE TRIGGER TRG_VERIFY_DUPLICATE_TRANSACTION
BEFORE INSERT
ON BORROWER_TRANS
FOR EACH ROW

DECLARE
	v_bTransID BORROWER_TRANS.bTransID%TYPE;

BEGIN
	--CHECK IF THE BORROWER TRANSACTION EXISTS OR NOT
	SELECT bTransID into v_bTransID
	FROM BORROWER_TRANS
	WHERE borrowerID = :NEW.borrowerID AND
	      ISBN = :NEW.ISBN AND
	      borrowerTransStatusID = 'TS123' AND
	      actualReturnDate IS NULL;
	
	RAISE_APPLICATION_ERROR(-20006, 'Transaction ' || v_bTransID || ' duplicated!');


EXCEPTION
        WHEN NO_DATA_FOUND 
        THEN
                DBMS_OUTPUT.PUT_LINE ('Transaction is unique.');

END;
/